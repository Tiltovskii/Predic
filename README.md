# Predic
**Predict CS:GO and Dota 2 matches**

Что за Predic?
------------------------------------

Predic - это мой небольшой проект, в котором я хотел получать предсказание результата матчей, чтобы в последствии ставить на них и выходить в плюс. В начале была создана модель на базе библиотеки ***catboost***, которая предсказывала "вероятность" победы какой-то из команд. Почему я выделил ***вероятность*** в кавычки будет пояснено дальше: в разделе, как модель и данные устроены. В общем, тогда модель мне не понравилась, и её следовало переделать, поэтому я решил вместо градиентного бустинга над деревьями использовать нейронные сети в надежде, что данных так много, что я смогу преодолеть предел классического машинного обучения.

<p align='center'>
  <img src='/photos/testrisk.jpg' height='256' width='512'/>
</p>

Но, к сожалению, этого не произошло. Тогда я подумал, что может в Dota 2 все лучше, так как читал статью от [Tongzhou Wang](https://ssnl.github.io/blog/neural-network-to-predict-dota-game-results/), где он утверждал, что добился ***accuracy в 70%***. И действительно, в Dota 2 модель работает лучше, хоть у меня и не получилось достичь результатов Tongzhou Wang.

Dota 2 модель
------------------------------------

### Сбор данных
Данные для модели я собирал с сайта [joint.com](https://www.joindota.com/matches/), на котором есть внушительная статистика по матчам, из которой можно узнать призовые команды, на каком они месте, их процент побед, их количество очков и т.д. Так же у них собраны все матчи с 2011 года включительно. Сайт достаточно легкий и без капч, из-за чего парсинг можно провести очень быстро, если использовать ***aiohttp*** и ***asyncio***, что я и делал.

### Метрика
Метрику я решил выбрать стандартную: acсuracy, так как я нигде так и не смог найти, где можно пропарсить матчи и коэффициенты, которые на них были, благодаря чему можно было бы считать ROI или Yield, которые бы больше коррелировали с главной целью: ставками.

### Предобработка данных
Перед подачей данных в модель я использовал onehot encoder на игроках и героях. Заметив, что игроков в общей сложности вышло порядка 4700, а следовательно и onehot-вектор размера 1x4700, я решил уменьшить это число, использовав, [PCA](https://scikit-learn.org/stable/modules/generated/sklearn.decomposition.PCA.html) из scikit-learn, благодаря которому я уменьшил размерность признакового пространства игроков до 50. PCA я так же использовал и над героями, так как ***accuracy*** особо не изменилось, а данных стало меньше. 

### Модель
Подбирать гиперпараметры особо я не увидел смысла (хоть и занимался этим продолжительное время), так как они сильно не меняли ***accuracy*** на валидационной выборке.

Модель на выход выдает число 0 или 1, которое показывает победит ли команда номер 1 (на сайте она расположена слева) или проиграет.

### Рузультаты
И что мы имеем в итоге от данной модели:
Probability | accuracy | ratio |
--- | --- | --- 
Probability ∈ (0, 1) | 65% | 100% |
Probability ∈ (0, 0.4) U (0.6, 1)| 70% | 60% |
Probability ∈ (0, 0.35) U (0.65, 1)| 75% | 40% |
Probability ∈ (0, 0.3) U (0.7, 1)| 78% | 28% |

 ### Как интерпретировать таблицу?

Наша модель может выдавать не только 1 либо 0, но и уверенность в этом с помощью команды ***predict_proba***, и если мы будет брать более уверенные результаты, то есть которые больше какого-то числа 0.5+x либо меньше 0.5-x, где x ∈ [0, 0.5], то получим, что ***accuracy*** хорошо вырастет, но мы теряем матчи, на которыйе можем поставить, и ***ratio*** как раз показывает то, какой процент матчей мы будем теперь брать и ставить на них.

### Выводы

В принципе 40% матчей при доле верных ответов 0.75 неплохой результат. Правда, если ставить, то нужно бы иметь информацию о коэффициентах на эти матчи, так как они могут быть очень низкими (1.1 к примеру) и тогда окупаться такие ставки не будут.

CS:GO модели
------------------------------------

## Catboost модель

### Сбор данных

Данные собирались с сайта [hltv](https://www.hltv.org/), который имеет так же полную статистику, но уже по матчам в CS:GO. К сожалению, этот сайт имеет ограничение на кол-во обращений в минуту, из-за чего асинхронный парсинг не удалось реализовать, и парсинг был обычный да и ещё с засыпаниями.

Собирались данные о рейтинге, игроках, названиях команд, картах и чей это был пик.

Счёт, с которым закончилась карта, с помощью сигмоидной функции проектировался на отрезок [0, 1] следующим образом:

$$\frac{1}{(1+\exp(-\frac{score_1}{score_2}))^{\frac{5}{4}}}$$

, где $score_1$ - счет к концу карты первой команды, а $score_2$ - соответсвенно второй

Формула выбрана такая только из-за того, что она показывала удовлетворяющую интуитивную проекцию на [0, 1].

Это значение теперь становилось таргетным, так как такое число дает больше информации об исходе матча, и задача из классификации переходила в задачу регрессии.

То есть если бы была классификация на множестве {1,0}, где 1 - это победа первой команды, а 0 - проигрыш, то матчи со счётом 16-14 и 16-0 были бы идентичны, что неправда. 

### Метрика

Метрикой снова была выбрана accuracy всё из-за того же, что нет коэффициентов.

### Модель

Модель сильно не отличается от модели Dota 2. 
- Так же был использован PCA алгоритм для сокращения вектора игроков.

- Была попытка реализации кросс-валидации со скользящим окном, но она не помогла достичь явного изменения метрики.

- На выходе модель теперь выдает не только число 1 или 0, а ещё и любое из их промежутка, так как таргет теперь зависит от счета, с которым они закончили.

### Рузультаты
И что мы имеем в итоге от данной модели:
Probability | accuracy | ratio |
--- | --- | --- 
Probability ∈ (0, 1) | 61% | 100% |
Probability ∈ (0, 0.4) U (0.6, 1)| 69% | 30% |
Probability ∈ (0, 0.35) U (0.65, 1)| 77% | 13,5% |
Probability ∈ (0, 0.3) U (0.7, 1)| 86,5% | 5,3% |

Интерпретация таблицы та же.

### Выводы

***Accuracy*** низок и если выбирать более уверенные матчи, то метрика хорошо подскакивает, но, к большому сожалению, мы будем брать тогда очень маленький процент матчей, поэтому попытку я считаю провальной.

## Реализация бота в телеграмме

Для удобства был сделан бот в телеграмме, в котором можно было посмотреть предсказание матчей, которые проходят сегодня, завтра, послезавтра. 
Модель обновляла в час ночи данные за день и заново обучалась.

## NN модель

Это обычная полносвязная нейронная сеть небольшой глубины, которая работает на бо́льшем объеме данных, но которые обрабатываются идентично как и с catboost моделью.
Если пытаться модель сделать больше, то на данных за 5 лет она прекратит обучаться и ***accuracy*** на валидационной выборке будет около 51%, поэтому я оставил её неглубокой.

### Метрика

Метрикой снова была выбрана accuracy всё из-за того же, что нет коэффициентов.

### Результаты

Probability | accuracy | ratio |
--- | --- | --- 
Probability ∈ (0, 1) | 61,5% | 100% |
Probability ∈ (0, 0.4) U (0.6, 1)| 73,8% | 19% |
Probability ∈ (0, 0.35) U (0.65, 1)| 76,3% | 10% |
Probability ∈ (0, 0.3) U (0.7, 1)| 80,1% | 1,9% |

### Выводы

Результаты схожи с catboost моделью, и так как градиентный бустинг над деревьями более лёгок, то я бы предпочел его использовать в дальнейшем.

Общие выводы и что следовало бы изменить
------------------------------------

Результаты оказались слабыми и показывают, что модели нуждаются в некой доработке. 

- Надо придумать, как в Dota 2 связать игрока и героя, на котором он играет. Такого в модели не было сделано.
- Присутствует несимметричность результатов относительно того, какую команду считать первой, а какую - второй. То есть он выдает разные вероятности на победу одной и той же команды, если её данные поменять местами с данными второй команды. Интересно, что не помогла аугментация данных, когда такие замены были осуществлены. 
- Проблема, что код плохочитаемый, но это уже несвязано с качеством модели.
- Все же следует попытаться собрать коэффициенты на команды и тогда рассчитать метрику ROI или Yield. Тогда, скорее всего, парсить матчи придется каждый день, что долго для сбора хорошей выборки.

 
